assert_function iai || exit

function iai-sync () {
	if test "$1" == "repo"
	then
		iai-sync-repo
	else
	  iai-sync-all
	fi
}

# TODO use https://stedolan.github.io/jq
function json-value () {
  local data="${1:?'missing data ($1)'}"
  node -e "console.log(${data}${2})" || fail
}

# git log --oneline --graph --decorate --date-order

function iai-sync-repo () {
	local repo="${1:-$(iai repo)}"
	test -z "$repo" && emsg "can't sync because can't find git repo" && exit 1
 
  cd "$repo" || fail
  repo="~${repo#$HOME}"
  info "fetching %s..." "$repo"
  git fetch
  local data="$(iai git-status)"
  case "$(json-value "$data" .action)" in
    fetch)
      info "current branch (%s) is up-to-date" "$(json-value "$data" .branch)"
      ;;
    push)
      info "pushing %s..." "$repo"
      git push || exit
      ;;
    pull)
      info "pulling %s..." "$repo"
      git pull --ff-only || exit
      iai git-status
      iai working
      ;;
    *)
      emsg "can't determine what to do"
      json-value "$data"
      return 1
      ;;
  esac
  warn "skiping remote sync @shitbook"
  exit 1
  if test "$(hostname)" != "shitbook"
  then
    utip "> # remote pull @shitbook through ssh"
    ssh shitbook "cd $repo && git pull" || fail "can't pull on shitbook"
  fi
  utip "> git status # (local) after sync!"
  git status
}

function iai-sync-all () {
  info "Sincronizando todos os repositorios..."
	{
		iai-sync-repo ~/Proxectos/iai
    iai-sync-repo ~/Proxectos/empresa.lorenzogrv.com
	} # |& utip
  info "Sincronizados todos os repositorios."
}

##
# vim modeline
# /* vim: set filetype=sh ts=2 shiftwidth=2: */
