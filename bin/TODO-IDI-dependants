#!/usr/bin/env node

/**
 * # dependants
 * 
 * shows information about module dependencies
 *
 * TODO this is currently an experiment with require.main
 */

// DEPENDENCIES

var resolve = require('path').resolve;
var format = require('util').format;

// ARGV

var argv = process.argv.slice( 2 );
if( argv.length > 1 || argv[0] == '--usage' || argv[0] == '--help' ){
  console.log('Usage: dependants [path to module or package]');
  process.exit(1);
}

var path = resolve( process.cwd(), argv[0] || '' );

try {
  var mod = require( path );
} catch( err ){
  if( err.code != 'MODULE_NOT_FOUND' ){
    throw err;
  }
  console.error( path + ' is not a commonjs package' );
  process.exit(1);
}


function listDependants( mod, out ){
  out = out || {};
  if( out[mod.filename]) throw "Ooops";
  out[ mod.filename ] = ! mod.children.length
    ? []
    : mod.children.map(function( mod ){
      listDependants( mod, out );
      return mod.filename;
    })
  ;
  return out;
}

function listSources( mod ){
  return []
    .concat.apply( [], mod.children.map(listSources) )
    .concat( mod.filename )
  ;
}

console.log( JSON.stringify( listDependants(require.main), null, 4 ) );

console.log( listSources(require.main) );

console.log( [ "algo" ].concat( ["mais", "de", "ca√±as"]) )
