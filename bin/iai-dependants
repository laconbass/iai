#!/usr/bin/env node

/**
 * # dependants
 * 
 * shows information about module dependencies
 *
 * TODO this is currently an experiment with require.main
 */

// DEPENDENCIES

const path = require('path')
const sources = require('@iaigz/tool-package-sources')
const cwdpackage = require('@iaigz/tool-package-cwdpackage')

// ARGV

let argv = process.argv.slice(2)
if( argv.length > 1 || argv[0] == '--usage' || argv[0] == '--help' ){
  console.log('Usage: dependants [path to module *.js or package dir]')
  process.exit(1)
}

let modpath = path.resolve(argv[0] || cwdpackage().__dirname)
let mod = null

console.error('researching %s dependencies...', modpath)

try {
  modpath = require.resolve(modpath)
} catch( err ){
  if( err.code === 'MODULE_NOT_FOUND' ){
    if(!~err.message.indexOf(modpath)){
      // not found module error may be related to a missing dependency
      throw err
    }
    console.error(modpath + ' does not resolve to a CommonJS module')
    console.error(require(path.resolve(modpath, 'package.json')))
    console.error('Maybe package.json "main" file is missing? check above')
    process.exit(1)
  }
  throw err;
}
mod = require(modpath)
var t = Date.now()
var result = sources(require.cache[modpath])
t = Date.now() - t
console.log(JSON.stringify(result, null, 4))
console.error('%s DEPENDS ON %s FILES (%sms)', modpath, result.length, t)
