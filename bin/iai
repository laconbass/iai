#! /bin/bash

##
# research the directory where this script is stored
# see http://stackoverflow.com/a/246128/1894803
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

source helper.bash

iai () {
  echo "running iai inside function"
}
case "$1" in
  "")
    echo "123456789012345678901234567890123" # 3*10+3=36 cols
    echo "----------------=----------------"
    echo "----------=-----------=----------"
    echo "--------=-------=-------=--------"
    echo "----=----=---==---==---=----=----"
    echo "ollo 0ll0 oVo  -*-  0v0 o11o 0110"
    echo "ollo 0ll0 oVo  iai  0v0 o11o 0110"
    echo "ollo 0ll0 oVo  -*-  0v0 o11o 0110"
    echo "----=----=---==---==---=----=----"
    echo "--------=-------=-------=--------"
    echo "----------=-----------=----------"
    echo "----------------=----------------"
    echo "-----------------------------lolo"
    exit 0
  ;;
  id)
    if [ -x $2 ]; then
      echo "$(basename "$2" | sed 's/iai-//')"
      exit 0
    fi
    fail "miss exec perms: '$2'"
    exit 1
  ;;
  db)
    DB="$(iai dir)/db/$(iai id "$2")/$(hostname)"
    mkdir -p "$DB"
    echo "$DB"
  ;;
  dir)
    dirname $DIR || exit 1
  ;;
  date)
    date --rfc-3339=date || exit 1
  ;;
  hora)
    date --rfc-3339=seconds || exit 1
  ;;
  info|warn|fail)
    $1 "${@:2}"
    exit 0
  ;;
  "-h"|"-?"|"--help"|"help")
    echo "##"
    echo "# Here should be some help text"
    echo "##"
    echo "> available cmds (\$1):"
    tree $DIR
  ;;
  *)# run command
    CMD="$DIR/iai-$1"
    if [ -x "$CMD" ]
    then
      $CMD "${@:2}"
      # TODO Â¿? should cmd run inside a subshell to protect global scope vars
      # TODO => until they'r exported, subcommands seem to have no access to them
    else
      fail "miss cmd: $1"
      exit 1
    fi
  ;;
esac
